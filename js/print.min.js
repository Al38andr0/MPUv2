"use strict";var app=angular.module("print",["ngRoute","underscore","ui.bootstrap","ngTouch","services"]);var underscore=angular.module("underscore",[]);underscore.factory("_",function(){return window._});function googleTranslateElementInit(){new google.translate.TranslateElement({pageLanguage:"it",includedLanguages:"en"},"google_translate_element")}app.config(["$routeProvider","$locationProvider",function(b,a){a.html5Mode({enabled:true});b.when("/:loc/preventivo/:id",{templateUrl:"views/preventivo.html",controller:"prvCtrl"}).when("/:loc/ordine/:id",{templateUrl:"views/ordine.html",controller:"prvCtrl"}).when("/:loc/condizioni",{templateUrl:"views/condizioni.html"}).when("/:loc/privacy",{templateUrl:"views/privacy.html"}).when("/:loc/vetrina/:id",{templateUrl:"views/composizione.html",controller:"vetrinaCtrl"}).when("/:loc/composizione/:id",{templateUrl:"views/composizione.html",controller:"vetrinaCtrl"}).when("/:loc/articolo/:id",{templateUrl:"views/articolo.html",controller:"articoloCtrl"})}]);app.controller("mainCtrl",["$scope","$http","$rootScope","$location","_","dataSvc","$window",function(j,g,h,c,i,b,a){j.vm={};j.fnz={};b.nazioni().then(function(l){j.vm.nazioni=l.data});b.province().then(function(l){j.vm.province=l.data});b.riv().then(function(l){j.vm.rivenditori=l.data;i.each(j.vm.rivenditori,function(m){if(m.v==0){var n=i.find(j.vm.province,function(o){return o.i==m.p});m.prv=n.n}})});b.age().then(function(l){j.vm.agenti=l.data});b.marchi().then(function(l){j.vm.marchi=l.data});b.prodotti().then(function(l){j.vm.prodotti=l.data});b.linee().then(function(l){j.vm.linee=l.data});b.vetrine().then(function(l){j.vm.vetrine=l.data});b.composti().then(function(l){j.vm.composti=l.data});b.abbinamenti().then(function(l){j.vm.abbinamenti=l.data});b.finiture().then(function(l){j.vm.finiture=l.data});b.finitureTabelle().then(function(l){j.vm.finitureTabelle=l.data});j.fnz.convertToPositive=function(l){return Math.abs(l)};j.$on("$viewContentLoaded",function(l){a.ga("send","pageview",{page:c.url()})});Number.prototype.formatMoney=function(v,q,o){var u=this;var r;r=isNaN(v=Math.abs(v))?2:v;q=q==undefined?".":q;o=o==undefined?",":o;var p=u<0?"-":"";var m=parseInt(u=Math.abs(+u||0).toFixed(r))+"";var l;l=(l=m.length)>3?l%3:0;return p+(l?m.substr(0,l)+o:"")+m.substr(l).replace(/(\d{3})(?=\d)/g,"$1"+o)+(r?q+Math.abs(u-m).toFixed(r).slice(2):"")};j.fnz.convertPrice=function(l){return(l).formatMoney(2,",",".")};j.fnz.convert=function(l,p,o){var q=[];var n="";if(typeof l==="object"){for(var m=0;m<l.length;m++){i.each(j.vm[p],function(r){if(r.i==l[m]){q.push(r[o])}})}return q}else{i.each(j.vm[p],function(r){if(r.i==l){n=r[o]}});return n}};function k(o,l,n){return o.split(l,n).join(l).length}j.fnz.findLoc=function(){var m=k(c.path(),"/",1);var l=k(c.path(),"/",2);return c.path().slice(m+1,l)};j.fnz.findPage=function(){var m=k(c.path(),"/",2);var l=k(c.path(),"/",3);return c.path().slice(m+1,l)};j.fnz.findID=function(){var l=k(c.path(),"/",3);return c.path().slice(l+1)};if(j.fnz.findLoc()!="mpu"){var f=j.fnz.findLoc();var e=f.split("_").join(" ");b.province().then(function(l){var n=false;var m=i.find(l.data,function(o){return o.n==e});if(m){n=i.find(j.vm.rivenditori,function(o){return o.p==m.i})}else{n=i.find(j.vm.rivenditori,function(o){return o.n==e})}if(n){i.each(n.y,function(o){i.each(j.vm.marchi,function(p){if(o.i==p.i){p.s=(o.s==0)?p.s:o.s;p.v=o.v;p.d=o.d}})});j.vm.rivenditore=n}})}else{j.vm.rivenditore=false}var d=j.fnz.findID();g.post("../php/preventivo.php?p="+d,{}).success(function(l){j.prv=l});j.fnz.resumePrv=function(n){var q=j.fnz.findLoc();var m=j.fnz.findID();var l=j.prv;if(l.prv.u!=0){var p=i.find(j.vm.rivenditori,function(r){return r.i==l.prv.u});if(p.v!=0){q=p.n}else{var o=j.fnz.convert(p.p,"province","n");q=o.split(" ").join("_")}if(n==0){window.open("../"+q+"/preventivo?q="+m,"_blank")}else{window.open("../"+q+"/form?q="+m,"_blank")}}else{if(n==0){window.open("../"+q+"/preventivo?q="+m,"_blank")}else{window.open("../"+q+"/form?q="+m,"_blank")}}};j.fnz.scontistica=function(n,l,m,o){var p=n+((n*m)/100);p+=(p*l)/100;p+=(p*o)/100;return Math.ceil(p)}}]);app.controller("prvCtrl",["$scope","$http","$rootScope","$location","_","$timeout","pagamenti",function(b,h,a,g,c,d,f){b.rivenditore={nome:false,tel:false,email:false};b.agente={nome:false};b.vm.pagamenti=f;var e=function(){if(h.pendingRequests.length>0){d(e)}else{b.date=new Date(b.prv.data*1000);b.ordDate=new Date(b.prv.OrdData*1000);var m,j,l;var i=b.prv.prv;b.dataPrv={};b.dataPrv.quantificare=false;b.dataPrv.rivenditore=false;b.dataPrv.totale=b.fnz.convertPrice(i.z);if(i.u!=0){j=c.find(b.vm.rivenditori,function(n){return n.i==i.u});b.rivenditore.nome=j.n;b.rivenditore.tel=j.h;b.rivenditore.email=j.e;b.rivenditore.conv=(j.v!=0)}else{m=c.find(b.vm.rivenditori,function(n){return n.p==i.pr});if(m){b.dataPrv.rivNome=m.n;b.dataPrv.rivTel=m.h;b.dataPrv.rivMail=m.e;b.dataPrv.rivenditore=true}else{m=c.find(b.vm.province,function(n){return n.i==i.pr});b.dataPrv.rivenditore=false}}if(i.g!=0){l=c.find(b.vm.agenti,function(n){return n.i==i.g});b.agente.nome=l.n;b.agente.tel=l.t;b.agente.email=l.e}if(i.pr==0){b.dataPrv.prNome=b.fnz.convert(j.p,"province","n")}else{b.dataPrv.prNome=b.fnz.convert(i.pr,"province","n")}if(i.tm==2||i.tm==1){switch(i.j){case 1:if(i.t==0){b.dataPrv.trasporto="gratuito"}else{b.dataPrv.trasporto=b.fnz.convertPrice(i.t)+" €"}b.dataPrv.quantificare=false;break;case 2:b.dataPrv.trasporto=b.fnz.convertPrice(i.t)+" €";b.dataPrv.quantificare=false;break;case 3:i.t=0;b.dataPrv.trasporto="N/A**";b.dataPrv.quantificare=true;i.b=0;break}if(i.tm==2){switch(i.k){case 1:if(i.m==0){b.dataPrv.montaggio="gratuito"}else{b.dataPrv.montaggio=b.fnz.convertPrice(i.m)+" €"}b.dataPrv.quantificare=false;break;case 2:b.dataPrv.montaggio=b.fnz.convertPrice(i.m)+" €";b.dataPrv.quantificare=false;break;case 3:i.m=0;b.dataPrv.montaggio="N/A**";b.dataPrv.quantificare=true;i.b=0;break}}else{i.m=0;b.dataPrv.montaggio="non richiesto";b.dataPrv.quantificare=false}}else{i.t=0;b.dataPrv.trasporto="non richiesto";i.m=0;b.dataPrv.montaggio="non richiesto";b.dataPrv.quantificare=false}if(i.z<i.l&&!b.dataPrv.quantificare){b.dataPrv.minimo=b.fnz.convertPrice(i.b);b.dataPrv.limite=b.fnz.convertPrice(i.l)}else{i.b=0;b.dataPrv.minimo=false;b.dataPrv.limite=false}b.dataPrv.sav=Math.ceil((i.z*i.a)/100);b.dataPrv.sas=b.fnz.convertPrice(b.dataPrv.sav);var k=i.z+i.b+i.t+i.m+b.dataPrv.sav;b.dataPrv.ivaNumber=(k*22)/100;b.dataPrv.iva=b.fnz.convertPrice(b.dataPrv.ivaNumber)+" €";b.dataPrv.complessivo=b.fnz.convertPrice(i.z+i.b+i.t+i.m+b.dataPrv.sav+b.dataPrv.ivaNumber)}};d(e)}]);app.controller("vetrinaCtrl",["$scope","$http","$rootScope","$location","_","$timeout","dataSvc",function(l,i,j,e,k,b,c){l.replaceAll=function(m,o,n){return m.replace(new RegExp(o,"g"),n)};l.cmp={prd:[],prezzo:0,cmp:{}};var a="Vetrina";var h="vtr";var f="vetrineProdotti";var d="vetrine";var g=function(){if(i.pendingRequests.length>0){b(function(){g()})}else{l.cmp.cmp=k.find(l.vm[d],function(m){return m.i==l.fnz.findID()});l.cmp.cmp.marchio=l.fnz.convert(l.cmp.cmp.m,"marchi","n");l.cmp.cmp.linea=l.fnz.convert(l.cmp.cmp.l,"linee","n");l.cmp.cmp.consegna=l.fnz.convert(l.cmp.cmp.l,"linee","e");l.cmp.cmp.garanzia=l.fnz.convert(l.cmp.cmp.l,"linee","w");l.cmp.cmp.marchioPath=l.replaceAll(l.cmp.cmp.marchio," ","_");l.cmp.cmp.lineaPath=l.replaceAll(l.cmp.cmp.linea," ","_");l.cmp.cmp.path="../dashboard/archivio_dati/"+l.cmp.cmp.marchioPath+"/"+l.cmp.cmp.lineaPath+"/"+a+"/"+l.cmp.cmp.lineaPath+"_"+l.cmp.cmp.c+".jpg";l.cmp.cmp.type=h;c[f]().then(function(m){var n=k.filter(m.data,function(o){return o.c==l.fnz.findID()});k.each(n,function(p){var t=k.find(l.vm.prodotti,function(u){return u.i==p.p});t.qnt=p.q;t.pos=p.y;t.abb=p.u;t.fin=p.f;var r=k.find(t.z,function(u){return u.a==p.u}).z;t.marchio=l.fnz.convert(p.m,"marchi","n");var q=l.fnz.convert(p.m,"marchi","s");var s=l.fnz.convert(p.m,"marchi","b");t.linea=l.fnz.convert(p.l,"linee","n");var o=l.fnz.convert(p.l,"linee","s");t.prezzo=l.fnz.scontistica(r,q,s,o);t.marchioPath=l.replaceAll(t.marchio," ","_");t.lineaPath=l.replaceAll(t.linea," ","_");t.consegna=l.fnz.convert(p.l,"linee","e");t.garanzia=l.fnz.convert(p.l,"linee","w");t.path="../dashboard/archivio_dati/"+t.marchioPath+"/"+t.lineaPath+"/Prodotti/";l.cmp.prezzo+=t.prezzo*p.q;l.cmp.prd.push(t)})})}};g()}]);app.controller("articoloCtrl",["$scope","$http","$rootScope","$location","_","$timeout","dataSvc",function(d,h,b,g,e,f,a){d.replaceAll=function(i,k,j){return i.replace(new RegExp(k,"g"),j)};d.articolo={};var c=function(){if(h.pendingRequests.length>0){f(function(){c()})}else{d.articolo=e.find(d.vm.prodotti,function(m){return m.i==d.fnz.findID()});d.articolo.marchio=d.fnz.convert(d.articolo.m,"marchi","n");d.articolo.linea=d.fnz.convert(d.articolo.l,"linee","n");d.articolo.consegna=d.fnz.convert(d.articolo.l,"linee","e");d.articolo.garanzia=d.fnz.convert(d.articolo.l,"linee","w");d.articolo.marchioPath=d.replaceAll(d.articolo.marchio," ","_");d.articolo.lineaPath=d.replaceAll(d.articolo.linea," ","_");d.articolo.path="../dashboard/archivio_dati/"+d.articolo.marchioPath+"/"+d.articolo.lineaPath+"/Prodotti/";var j=d.fnz.convert(d.articolo.m,"marchi","s");var l=d.fnz.convert(d.articolo.m,"marchi","b");var i=d.fnz.convert(d.articolo.l,"linee","s");var k=d.fnz.scontistica(d.articolo.z[0].z,j,l,i);d.articolo.prezzo=d.fnz.convertPrice(k);if(d.articolo.f!=0){d.articolo.abb=e.find(d.vm.abbinamenti,function(m){return m.i==d.articolo.a});d.articolo.fin=d.fnz.convert(d.articolo.abb.f[0].i,"finiture","n")}else{e.each(d.articolo.z,function(m){m.tab=d.fnz.convert(m.a,"finitureTabelle","n");var n=d.fnz.scontistica(m.z,j,l,i);m.prezzo=d.fnz.convertPrice(n)})}console.log(d.articolo)}};c()}]);app.directive("preventivo",function(){return{restrict:"E",templateUrl:"templates/preventivo.html",scope:{fnz:"=",index:"=",articolo:"=",prv:"=",vm:"="},controller:function(b,c,d){b.replaceAll=function(e,g,f){return e.replace(new RegExp(g,"g"),f)};var a=function(e){if(d.pendingRequests.length>0){c(function(){a(e)})}else{var l=_.find(b.vm.prodotti,function(m){return m.i==e});b.item=angular.copy(l);b.item.abb=_.find(b.vm.abbinamenti,function(m){return m.i==b.articolo.a});var h=_.find(b.vm.marchi,function(m){return m.i==b.item.m});var j=_.find(b.vm.linee,function(m){return m.i==b.item.l});b.item.price=b.fnz.convertPrice(b.articolo.z);b.item.linea=j.n;var f=b.replaceAll(h.n," ","_");var k=b.replaceAll(j.n," ","_");var i="../dashboard/archivio_dati/"+f+"/"+k+"/";b.item.pathPdf=i+k+"_specifiche.pdf";b.item.pathImg=i+"Prodotti/"+b.item.c+".jpg";b.item.pathFin="../dashboard/archivio_dati/"+f+"/Finiture/";if(h.d&&h.d!=0){b.item.consegna=h.d}else{b.item.consegna=j.e}b.item.garanzia=j.w;b.item.q=1;b.tbpr=b.item.t;var g=_.find(b.vm.finitureTabelle,function(m){return m.i==b.articolo.u});b.item.u=g.n;delete b.item.a;delete b.item.f;delete b.item.m;delete b.item.y;delete b.item.x;delete b.item.z;delete b.item.q}};c(function(){a(b.articolo.i)})}}});app.directive("composizione",function(){return{restrict:"E",templateUrl:"templates/composizione.html",scope:{item:"=",prezzo:"=",fnz:"="}}});app.directive("articolo",function(){return{restrict:"E",templateUrl:"templates/articolo.html",scope:{item:"=",vm:"=",fnz:"=",obj:"@"}}});